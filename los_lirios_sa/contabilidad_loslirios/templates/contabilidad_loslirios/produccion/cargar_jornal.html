{% extends "contabilidad_loslirios/main.html" %}
{% load static %}

{% block titulo %}Cargar Jornales - Los Lirios SA{% endblock titulo %}

{% block contenido %}
    {# Mensajes de Django (Toastify-js los leerá y los mostrará) #}
    {% if messages %}
        <ul class="messages mb-4 hidden"> {# Añade 'hidden' para que no se muestren dos veces #}
            {% for message in messages %}
                <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}
    
    <div class="flex items-center mb-6">
        <a href="{% url 'produccion' %}" class="text-blue-600 hover:text-blue-800 flex items-center">
            <i class="fas fa-arrow-left mr-2"></i> Volver a Producción
        </a>
        <h1 class="text-2xl font-semibold text-gray-800 ml-4">Cargar Jornales</h1>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md">
        <form method="post" id="formulario-jornales" class="space-y-4">
            {% csrf_token %}
            {{ formset.management_form }}
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200" id="tabla-jornales">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trabajador</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Clasificación</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tarea</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Detalle</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unidad</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ubicación</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for form in formset %}
                        <tr class="formset-row">
                            <td class="px-2 py-2">
                                {{ form.fecha }}
                                <button type="button" class="btn-copiar-fecha bg-gray-300 hover:bg-gray-400 text-xs px-2 py-1 rounded ml-1 transition-colors" title="Copiar fecha anterior">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </td>
                            <td class="px-2 py-2">{{ form.nombre_trabajador }}</td>
                            <td class="px-2 py-2">{{ form.clasificacion }}</td>
                            <td class="px-2 py-2">{{ form.tarea }}</td>
                            <td class="px-2 py-2">{{ form.detalle }}</td>
                            <td class="px-2 py-2">{{ form.cantidad }}</td>
                            <td class="px-2 py-2">{{ form.unidad_medida }}</td>
                            <td class="px-2 py-2">{{ form.precio }}</td>
                            <td class="px-2 py-2">{{ form.ubicacion }}</td>
                            <td class="px-2 py-2 text-center">
                                <button type="button" class="btn-eliminar bg-red-500 hover:bg-red-600 text-white text-xs px-2 py-1 rounded transition-colors" title="Eliminar fila">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="flex justify-between items-center mt-6">
                <button type="button" id="btn-agregar" class="btn bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg font-medium flex items-center transition-colors">
                    <i class="fas fa-plus mr-2"></i>Agregar Fila
                </button>
                
                <button type="submit" class="btn bg-green-600 hover:bg-green-700 text-white py-2 px-6 rounded-lg font-medium flex items-center transition-colors">
                    <i class="fas fa-save mr-2"></i>Guardar Jornales
                </button>
            </div>
        </form>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // === CONFIGURACIÓN INICIAL ===
        const tabla = document.getElementById('tabla-jornales').getElementsByTagName('tbody')[0];
        const btnAgregar = document.getElementById('btn-agregar');
        const totalForms = document.getElementById('id_form-TOTAL_FORMS');

        // === FUNCIÓN PRINCIPAL PARA MANEJAR EVENTOS DE CLASIFICACIÓN/TAREA ===
        function initializeClasificacionEvents() {
            // Remover eventos existentes para evitar duplicación
            document.querySelectorAll('select[name$="-clasificacion"]').forEach(function(select) {
                // Clonar el select para remover todos los event listeners
                const newSelect = select.cloneNode(true);
                select.parentNode.replaceChild(newSelect, select);
            });

            // Agregar eventos nuevamente a todos los selects de clasificación
            document.querySelectorAll('select[name$="-clasificacion"]').forEach(function(clasificacionSelect) {
                const row = clasificacionSelect.closest('tr');
                const tareaSelect = row.querySelector('select[name$="-tarea"]');
                
                if (clasificacionSelect && tareaSelect) {
                    // Guardar valor actual de tarea antes de actualizar
                    const tareaActual = tareaSelect.value;
                    
                    // Event listener para cambios de clasificación
                    clasificacionSelect.addEventListener('change', function() {
                        actualizarTareas(clasificacionSelect, tareaSelect);
                    });
                    
                    // Inicializar tareas si hay clasificación seleccionada
                    if (clasificacionSelect.value) {
                        actualizarTareas(clasificacionSelect, tareaSelect, tareaActual);
                    }
                }
            });
        }

        // === FUNCIÓN PARA ACTUALIZAR TAREAS SEGÚN CLASIFICACIÓN ===
        function actualizarTareas(clasificacionSelect, tareaSelect, valorPrevio = null) {
            const clasificacion = clasificacionSelect.value;
            
            if (!clasificacion) {
                tareaSelect.innerHTML = '<option value="">Seleccione una clasificación primero</option>';
                tareaSelect.disabled = true;
                return;
            }

            tareaSelect.innerHTML = '<option value="">Cargando...</option>';
            tareaSelect.disabled = true;

            fetch(`/api/administracion/get-tasks/${clasificacion}/`)
                .then(response => response.json())
                .then(data => {
                    tareaSelect.innerHTML = '<option value="">Seleccione una tarea</option>';
                    
                    data.tasks.forEach(function(task) {
                        const option = new Option(task, task);
                        // Mantener valor previo si existe
                        if (valorPrevio && task === valorPrevio) {
                            option.selected = true;
                        }
                        tareaSelect.add(option);
                    });
                    
                    tareaSelect.disabled = false;
                })
                .catch(error => {
                    console.error('Error al cargar tareas:', error);
                    tareaSelect.innerHTML = '<option value="">Error al cargar tareas</option>';
                    tareaSelect.disabled = true;
                });
        }

        // === FUNCIÓN PARA ACTUALIZAR ATRIBUTOS DE FORMSET ===
        function updateFormsetAttributes() {
            const filas = tabla.querySelectorAll('.formset-row');
            filas.forEach(function(fila, index) {
                fila.querySelectorAll('input, select, textarea').forEach(function(input) {
                    if (input.name) {
                        input.name = input.name.replace(/form-(\d+)-/, `form-${index}-`);
                    }
                    if (input.id) {
                        input.id = input.id.replace(/form-(\d+)-/, `form-${index}-`);
                    }
                });
            });
            totalForms.value = filas.length;
        }

        // === AGREGAR NUEVA FILA ===
        btnAgregar.addEventListener('click', function() {
            const filas = tabla.querySelectorAll('.formset-row');
            const ultimaFila = filas[filas.length - 1];
            const nuevaFila = ultimaFila.cloneNode(true);

            // Limpiar valores de inputs manteniendo estructura
            nuevaFila.querySelectorAll('input, select, textarea').forEach(function(input) {
                if (input.type === 'checkbox' || input.type === 'radio') {
                    input.checked = false;
                } else {
                    input.value = '';
                }
                
                // Resetear estado de los selects de tarea
                if (input.name && input.name.includes('-tarea')) {
                    input.innerHTML = '<option value="">Seleccione una clasificación primero</option>';
                    input.disabled = true;
                }
            });

            tabla.appendChild(nuevaFila);
            
            // Actualizar atributos del formset
            updateFormsetAttributes();
            
            // Reinicializar eventos
            setTimeout(initializeClasificacionEvents, 100);
        });

        // === ELIMINAR FILA ===
        tabla.addEventListener('click', function(e) {
            if (e.target.classList.contains('btn-eliminar') || e.target.closest('.btn-eliminar')) {
                const filas = tabla.querySelectorAll('.formset-row');
                if (filas.length > 1) {
                    e.target.closest('.formset-row').remove();
                    
                    // Actualizar atributos del formset
                    updateFormsetAttributes();
                    
                    // Reinicializar eventos (CRUCIAL)
                    setTimeout(initializeClasificacionEvents, 100);
                } else {
                    alert('Debe mantener al menos una fila.');
                }
            }
        });

        // === COPIAR FECHA ANTERIOR ===
        tabla.addEventListener('click', function(e) {
            if (e.target.classList.contains('btn-copiar-fecha') || e.target.closest('.btn-copiar-fecha')) {
                const filaActual = e.target.closest('tr');
                const filas = Array.from(document.querySelectorAll('#tabla-jornales .formset-row'));
                const idx = filas.indexOf(filaActual);
                
                if (idx > 0) {
                    const fechaAnterior = filas[idx - 1].querySelector('input[name$="-fecha"]').value;
                    if (fechaAnterior) {
                        filaActual.querySelector('input[name$="-fecha"]').value = fechaAnterior;
                    } else {
                        alert('La fila anterior no tiene fecha seleccionada.');
                    }
                } else {
                    alert('Esta es la primera fila, no hay fecha anterior para copiar.');
                }
            }
        });

        // === INICIALIZACIÓN ===
        initializeClasificacionEvents();
    });
    </script>

    <style>
        /* === ESTILOS MEJORADOS PARA LA TABLA === */
        #tabla-jornales input,
        #tabla-jornales select,
        #tabla-jornales textarea {
            max-width: 140px;
            min-width: 100px;
            width: 110px;
            box-sizing: border-box;
            padding: 0.375rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        #tabla-jornales input:focus,
        #tabla-jornales select:focus,
        #tabla-jornales textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        #tabla-jornales th, 
        #tabla-jornales td {
            padding: 0.5rem;
        }

        /* Estilo para campos deshabilitados */
        #tabla-jornales select:disabled {
            background-color: #f9fafb;
            color: #6b7280;
            cursor: not-allowed;
        }

        /* Mejoras visuales para botones */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.15s ease-in-out;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* Responsividad de la tabla */
        @media (max-width: 768px) {
            #tabla-jornales input,
            #tabla-jornales select,
            #tabla-jornales textarea {
                max-width: 100px;
                min-width: 80px;
                width: 90px;
                font-size: 0.75rem;
            }
            
            #tabla-jornales th,
            #tabla-jornales td {
                padding: 0.25rem;
            }
        }
    </style>
{% endblock %}