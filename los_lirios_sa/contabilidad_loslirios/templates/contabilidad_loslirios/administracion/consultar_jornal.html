{% extends "contabilidad_loslirios/main.html" %}
{% load static %}

{% block titulo %}Consultar Jornales - Los Lirios SA{% endblock titulo %}

{% block contenido %}
        <div class="flex items-center mb-6">
            <a href="{% url 'contabilidad' %}" class="text-blue-600 hover:text-blue-800 flex items-center">
                <i class="fas fa-arrow-left mr-2"></i> Volver a Administracion
            </a>
            <h1 class="text-2xl font-semibold text-gray-800 ml-4">Consultar Jornales</h1>
        </div>

        {# Formulario de Filtros #}
        <form method="GET" class="mb-8" id="filtro-form">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {# Campo Fecha Desde #}
                <div>
                    <label for="{{ form.fecha_desde.id_for_label }}" class="block text-gray-700 text-sm font-bold mb-2">{{ form.fecha_desde.label }}</label>
                    {{ form.fecha_desde }}
                    {% if form.fecha_desde.errors %}
                        <p class="text-red-500 text-xs italic">{{ form.fecha_desde.errors }}</p>
                    {% endif %}
                </div>
                {# Campo Fecha Hasta #}
                <div>
                    <label for="{{ form.fecha_hasta.id_for_label }}" class="block text-gray-700 text-sm font-bold mb-2">{{ form.fecha_hasta.label }}</label>
                    {{ form.fecha_hasta }}
                    {% if form.fecha_hasta.errors %}
                        <p class="text-red-500 text-xs italic">{{ form.fecha_hasta.errors }}</p>
                    {% endif %}
                </div>
                {# Campo Nombre del Trabajador #}
                <div>
                    <label for="{{ form.nombre_trabajador.id_for_label }}" class="block text-gray-700 text-sm font-bold mb-2">{{ form.nombre_trabajador.label }}</label>
                    {{ form.nombre_trabajador }}
                </div>
                {# Campo Clasicacion #}
                <div>
                    <label for="{{ form.clasificacion.id_for_label }}" class="block text-gray-700 text-sm font-bold mb-2">{{ form.clasificacion.label }}:</label>
                    {{ form.clasificacion }}
                </div>
                {# Campo Tarea #}
                <div>
                    <label for="{{ form.tarea.id_for_label }}" class="block text-gray-700 text-sm font-bold mb-2">{{ form.tarea.label }}</label>
                    {{ form.tarea }}
                </div>
            </div>
            {% if form.non_field_errors %}
                <div class="text-red-500 text-xs italic mt-2">
                    {% for error in form.non_field_errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}
            <div class="mt-6 flex justify-center">
                <button type="submit" class="btn bg-green-600 hover:bg-green-700 text-white py-2 px-6 rounded-lg font-medium flex items-center">
                    <i class="fas fa-search mr-2"></i> Buscar
                </button>
            </div>
        </form>
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Resultados de la Consulta</h2>

        {# Botones de Exportación #}
        <div class="flex justify-end mb-4 space-x-2">
            <a id="export-csv-btn" href="#" class="btn bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg font-medium">
                <i class="fas fa-file-csv mr-2"></i> Exportar CSV
            </a>
        </div>
        {# Contenedor de Resultados #}
        <div class="results-container mt-8">
            {% if registros %}
                <div class="overflow-x-auto shadow-md rounded-lg">
                    <table class="min-w-full bg-white">
                        <thead>
                            <tr>
                                <th class="py-3 px-4 uppercase font-semibold text-sm text-gray-600">Fecha</th>
                                <th class="py-3 px-4 uppercase font-semibold text-sm text-gray-600">Nombre</th>
                                <th class="py-3  uppercase font-semibold text-sm text-gray-600">Clasificación</th>
                                <th class="py-3 px-4 uppercase font-semibold text-sm text-gray-600">Tarea</th>
                                <th class="py-3  uppercase font-semibold text-sm text-gray-600">Detalle</th>
                                <th class="py-3 px-4 uppercase font-semibold text-sm text-gray-600">Cantidad</th>
                                <th class="py-3 px-4 uppercase font-semibold text-sm text-gray-600">Unidad</th>
                                <th class="py-3 px-4 uppercase font-semibold text-sm text-gray-600">Precio</th>
                                <th class="py-3 px-4 uppercase font-semibold text-sm text-gray-600">Ubicación</th>
                                <th class="py-3 px-4 uppercase font-semibold text-sm text-gray-600">Monto Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for registro in registros %} {# Ahora 'registros' es el objeto Page #}
                                <tr class="border-b border-gray-200 hover:bg-gray-100">
                                    <td class="py-3 px-4">{{ registro.fecha|date:"Y-m-d" }}</td>
                                    <td class="py-3 px-4">{{ registro.nombre_trabajador }}</td>
                                    <td class="py-3 px-4">{{ registro.get_clasificacion_display }}</td>
                                    <td class="py-3 px-4">{{ registro.tarea }}</td>
                                    <td class="py-3 px-4">{{ registro.detalle }}</td>
                                    <td class="py-3 px-4">{{ registro.cantidad }}</td>
                                    <td class="py-3 px-4">{{ registro.unidad_medida }}</td>
                                    <td class="py-3 px-4">${{ registro.precio|floatformat:2 }}</td>
                                    <td class="py-3 px-4">{{ registro.ubicacion }}</td>
                                    <td class="py-3 px-4">${{ registro.monto_total|floatformat:2 }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-gray-600 text-center py-4">No se encontraron registros que coincidan con los filtros.</p>
            {% endif %}
        </div>  
        {# Controles de Paginación #}
        <div class="pagination flex justify-center items-center mt-6 space-x-2">
            {% if registros.has_previous %}
                <a href="?page=1{% if request.GET.nombre_trabajador %}&nombre_trabajador={{ request.GET.nombre_trabajador }}{% endif %}{% if request.GET.tarea %}&tarea={{ request.GET.tarea }}{% endif %}{% if request.GET.fecha_desde %}&fecha_desde={{ request.GET.fecha_desde }}{% endif %}{% if request.GET.fecha_hasta %}&fecha_hasta={{ request.GET.fecha_hasta }}{% endif %}{% if request.GET.ubicacion %}&ubicacion={{ request.GET.ubicacion }}{% endif %}{% if request.GET.detalle %}&detalle={{ request.GET.detalle }}{% endif %}" class="btn bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg text-sm">&laquo; Primera</a>
                <a href="?page=1{% if request.GET.nombre_trabajador %}&nombre_trabajador={{ request.GET.nombre_trabajador }}{% endif %}{% if request.GET.tarea %}&tarea={{ request.GET.tarea }}{% endif %}{% if request.GET.fecha_desde %}&fecha_desde={{ request.GET.fecha_desde }}{% endif %}{% if request.GET.fecha_hasta %}&fecha_hasta={{ request.GET.fecha_hasta }}{% endif %}{% if request.GET.ubicacion %}&ubicacion={{ request.GET.ubicacion }}{% endif %}{% if request.GET.detalle %}&detalle={{ request.GET.detalle }}{% endif %}" class="btn bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg text-sm">Anterior</a>
            {% endif %}
            <span class="current-page text-gray-700 font-medium">
                Página {{ registros.number }} de {{ paginator.num_pages }}.
            </span>
            {% if registros.has_next %}
                <a href="?page=1{% if request.GET.nombre_trabajador %}&nombre_trabajador={{ request.GET.nombre_trabajador }}{% endif %}{% if request.GET.tarea %}&tarea={{ request.GET.tarea }}{% endif %}{% if request.GET.fecha_desde %}&fecha_desde={{ request.GET.fecha_desde }}{% endif %}{% if request.GET.fecha_hasta %}&fecha_hasta={{ request.GET.fecha_hasta }}{% endif %}{% if request.GET.ubicacion %}&ubicacion={{ request.GET.ubicacion }}{% endif %}{% if request.GET.detalle %}&detalle={{ request.GET.detalle }}{% endif %}" class="btn bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg text-sm">Siguiente</a>
                <a href="?page={{ registros.next_page_number }}{% if request.GET.nombre_trabajador %}&nombre_trabajador={{ request.GET.nombre_trabajador }}{% endif %}{% if request.GET.tarea %}&tarea={{ request.GET.tarea }}{% endif %}{% if request.GET.fecha_desde %}&fecha_desde={{ request.GET.fecha_desde }}{% endif %}{% if request.GET.fecha_hasta %}&fecha_hasta={{ request.GET.fecha_hasta }}{% endif %}{% if request.GET.ubicacion %}&ubicacion={{ request.GET.ubicacion }}{% endif %}{% if request.GET.detalle %}&detalle={{ request.GET.detalle }}{% endif %}" class="btn bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg text-sm">Última &raquo;</a>
            {% endif %}
        </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const clasificacionSelect = document.getElementById('{{ form.clasificacion.id_for_label }}');
        const tareaSelect = document.getElementById('{{ form.tarea.id_for_label }}');

        function actualizarTareas() {
            const clasificacion = clasificacionSelect.value;
            const tareaActual = "{{ request.GET.tarea|default:'' }}"; 

            if (!clasificacion) {
                tareaSelect.innerHTML = '<option value="">Todas</option>';
                return;
            }

            tareaSelect.innerHTML = '<option value="">Cargando...</option>';
            const url = `{% url 'get_tasks_for_classification' '0' %}`.replace('0', clasificacion);

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    tareaSelect.innerHTML = '';
                    // La primera opción siempre será para no filtrar
                    tareaSelect.add(new Option('Todas', ''));

                    data.tasks.forEach(function(task) {
                        const option = new Option(task, task);
                        if (task === tareaActual) {
                            option.selected = true; // Si esta tarea era la filtrada, la dejamos seleccionada
                        }
                        tareaSelect.add(option);
                    });
                })
                .catch(error => {
                    console.error('Error al obtener las tareas:', error);
                    tareaSelect.innerHTML = '<option value="">Error al cargar</option>';
                });
        }

        clasificacionSelect.addEventListener('change', actualizarTareas);
        actualizarTareas(); // Llamar al cargar la página para poblar según el filtro actual
    });
    </script>
    {# Script para actualizar el enlace de exportación CSV con los filtros actuales #}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const filtroForm = document.getElementById('filtro-form');
            const exportCsvBtn = document.getElementById('export-csv-btn');

            function updateExportLinks() {
                const formData = new URLSearchParams(new FormData(filtroForm)).toString();
                
                // Asegúrate de que la URL de exportación CSV base sea correcta
                const baseCsvUrl = "{% url 'exportar_jornales_csv' %}";

                exportCsvBtn.href = `${baseCsvUrl}?${formData}`;
            }

            // Actualizar los enlaces cuando la página carga (para los filtros iniciales)
            updateExportLinks();
        });
    </script>
{% endblock contenido %}