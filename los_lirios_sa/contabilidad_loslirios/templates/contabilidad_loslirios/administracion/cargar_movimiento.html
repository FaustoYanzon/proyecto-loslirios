{% extends "contabilidad_loslirios/main.html" %}
{% load static %}

{% block titulo %}
    {% if modo == 'editar' %}Editar Movimiento{% else %}Cargar Movimiento{% endif %} - Los Lirios SA
{% endblock titulo %}

{% block contenido %}
    {# Mensajes de Django (Toastify-js los leerá y los mostrará) #}
    {% if messages %}
        <ul class="messages mb-4 hidden"> 
            {% for message in messages %}
                <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}

    <div class="flex items-center mb-6">
        <a href="{% url 'contabilidad' %}" class="text-blue-600 hover:text-blue-800 flex items-center">
            <i class="fas fa-arrow-left mr-2"></i> Volver a Administración
        </a>
        <h1 class="text-2xl font-semibold text-gray-800 ml-4">
            {% if modo == 'editar' %}
                Editar Movimiento Financiero
            {% else %}
                Cargar Movimientos Financieros
            {% endif %}
        </h1>
    </div>

    <!-- Indicador de modo edición -->
    {% if modo == 'editar' %}
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
        <div class="flex items-center">
            <i class="fas fa-info-circle text-blue-600 mr-2"></i>
            <span class="text-blue-800 font-medium">
                Editando movimiento del {{ movimiento.fecha|date:"d/m/Y" }} - {{ movimiento.tipo }} - ${{ movimiento.monto|floatformat:2 }}
            </span>
        </div>
    </div>
    {% endif %}

    <form method="POST" class="bg-white p-8 rounded-lg shadow-md" id="movimiento-form">
        {% csrf_token %}

        {% if errores_carga %}
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-6" role="alert">
                <strong class="font-bold">¡Error al guardar!</strong>
                <span class="block sm:inline">Por favor, corrija los siguientes errores:</span>
                <ul class="mt-2 list-disc list-inside">
                    {% for field, errors in errores_carga.items %}
                        <li>{{ field }}: {{ errors|join:", " }}</li>
                    {% endfor %}
                    {% if formulario.non_field_errors %}
                        {% for error in formulario.non_field_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    {% endif %}
                </ul>
            </div>
        {% endif %}

        <!-- Información General -->
        <fieldset class="border border-gray-300 p-6 rounded-md mb-6">
            <legend class="text-lg font-semibold px-3 bg-white text-gray-800">Información General</legend>
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mt-4">
                <div class="space-y-2">
                    <label for="{{ formulario.fecha.id_for_label }}" class="block text-gray-700 text-sm font-bold">Fecha:</label>
                    <input type="date" 
                           name="{{ formulario.fecha.name }}" 
                           id="{{ formulario.fecha.id_for_label }}"
                           value="{{ formulario.fecha.value|default:'' }}"
                           class="form-control border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full"
                           required>
                    {% if formulario.fecha.errors %}
                        <p class="text-red-500 text-xs italic mt-1">{{ formulario.fecha.errors|first }}</p>
                    {% endif %}
                </div>

                <div class="space-y-2">
                    <label for="{{ formulario.origen.id_for_label }}" class="block text-gray-700 text-sm font-bold">Origen:</label>
                    <select name="{{ formulario.origen.name }}" 
                            id="{{ formulario.origen.id_for_label }}"
                            class="form-control border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full"
                            required>
                        <option value="">Seleccione origen</option>
                        <option value="Oficial" {% if formulario.origen.value == 'Oficial' %}selected{% endif %}>Oficial</option>
                        <option value="No Oficial" {% if formulario.origen.value == 'No Oficial' %}selected{% endif %}>No Oficial</option>
                    </select>
                    {% if formulario.origen.errors %}
                        <p class="text-red-500 text-xs italic mt-1">{{ formulario.origen.errors|first }}</p>
                    {% endif %}
                </div>

                <div class="space-y-2">
                    <label for="{{ formulario.finca.id_for_label }}" class="block text-gray-700 text-sm font-bold">Finca:</label>
                    <select name="{{ formulario.finca.name }}" 
                            id="{{ formulario.finca.id_for_label }}"
                            class="form-control border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full"
                            required>
                        <option value="">Seleccione finca</option>
                        <option value="Los Mimbres" {% if formulario.finca.value == 'Los Mimbres' %}selected{% endif %}>Los Mimbres</option>
                        <option value="Media Agua" {% if formulario.finca.value == 'Media Agua' %}selected{% endif %}>Media Agua</option>
                        <option value="Caucete" {% if formulario.finca.value == 'Caucete' %}selected{% endif %}>Caucete</option>
                    </select>
                    {% if formulario.finca.errors %}
                        <p class="text-red-500 text-xs italic mt-1">{{ formulario.finca.errors|first }}</p>
                    {% endif %}
                </div>
            </div>
        </fieldset>

        <!-- Clasificación del Gasto -->
        <fieldset class="border border-gray-300 p-6 rounded-md mb-4">
            <legend class="text-lg font-semibold px-3 bg-white text-gray-800">Clasificación del Gasto</legend>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                <div class="space-y-2">
                    <label for="{{ formulario.tipo.id_for_label }}" class="block text-gray-700 text-sm font-bold">Tipo de Gasto:</label>
                    <select name="{{ formulario.tipo.name }}" 
                            id="{{ formulario.tipo.id_for_label }}"
                            class="form-control border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full"
                            required>
                        <option value="">Seleccione tipo</option>
                        <option value="Sueldos Personal" {% if formulario.tipo.value == 'Sueldos Personal' %}selected{% endif %}>Sueldos Personal</option>
                        <option value="Produccion" {% if formulario.tipo.value == 'Produccion' %}selected{% endif %}>Producción</option>
                        <option value="Inversion" {% if formulario.tipo.value == 'Inversion' %}selected{% endif %}>Inversión</option>
                        <option value="Repuestos y Reparaciones" {% if formulario.tipo.value == 'Repuestos y Reparaciones' %}selected{% endif %}>Repuestos y Reparaciones</option>
                        <option value="Insumos Varios" {% if formulario.tipo.value == 'Insumos Varios' %}selected{% endif %}>Insumos Varios</option>
                        <option value="Impuestos o Servicios" {% if formulario.tipo.value == 'Impuestos o Servicios' %}selected{% endif %}>Impuestos o Servicios</option>
                        <option value="Energia" {% if formulario.tipo.value == 'Energia' %}selected{% endif %}>Energía</option>
                    </select>
                    {% if formulario.tipo.errors %}
                        <p class="text-red-500 text-xs italic mt-1">{{ formulario.tipo.errors|first }}</p>
                    {% endif %}
                </div>

                <div class="space-y-2">
                    <label for="{{ formulario.clasificacion.id_for_label }}" class="block text-gray-700 text-sm font-bold">Clasificación:</label>
                    <select name="{{ formulario.clasificacion.name }}" 
                            id="{{ formulario.clasificacion.id_for_label }}"
                            class="form-control border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full"
                            required>
                        <option value="">Seleccione un tipo primero</option>
                        <!-- Las opciones se cargan dinámicamente via JavaScript -->
                    </select>
                    {% if formulario.clasificacion.errors %}
                        <p class="text-red-500 text-xs italic mt-1">{{ formulario.clasificacion.errors|first }}</p>
                    {% endif %}
                </div>

                <div class="space-y-2 md:col-span-2">
                    <label for="{{ formulario.detalle.id_for_label }}" class="block text-gray-700 text-sm font-bold">Detalle:</label>
                    <textarea name="{{ formulario.detalle.name }}" 
                              id="{{ formulario.detalle.id_for_label }}"
                              rows="3"
                              placeholder="Descripción detallada del movimiento..."
                              class="form-control border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full resize-none">{{ formulario.detalle.value|default:'' }}</textarea>
                    {% if formulario.detalle.errors %}
                        <p class="text-red-500 text-xs italic mt-1">{{ formulario.detalle.errors|first }}</p>
                    {% endif %}
                </div>
            </div>
        </fieldset>

        <!-- Información Financiera -->
        <fieldset class="border border-gray-300 p-6 rounded-md mb-6">
            <legend class="text-lg font-semibold px-3 bg-white text-gray-800">Información Financiera</legend>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-4">
                <div class="space-y-2">
                    <label for="{{ formulario.monto.id_for_label }}" class="block text-gray-700 text-sm font-bold">Monto:</label>
                    <input type="number" 
                           name="{{ formulario.monto.name }}" 
                           id="{{ formulario.monto.id_for_label }}"
                           value="{{ formulario.monto.value|default:'' }}"
                           placeholder="0.00"
                           step="0.01"
                           min="0"
                           class="form-control border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full"
                           required>
                    {% if formulario.monto.errors %}
                        <p class="text-red-500 text-xs italic mt-1">{{ formulario.monto.errors|first }}</p>
                    {% endif %}
                </div>

                <div class="space-y-2">
                    <label for="{{ formulario.moneda.id_for_label }}" class="block text-gray-700 text-sm font-bold">Moneda:</label>
                    <select name="{{ formulario.moneda.name }}" 
                            id="{{ formulario.moneda.id_for_label }}"
                            class="form-control border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full"
                            required>
                        <option value="">Seleccione moneda</option>
                        <option value="ARS" {% if formulario.moneda.value == 'ARS' %}selected{% endif %}>Pesos (ARS)</option>
                        <option value="USD" {% if formulario.moneda.value == 'USD' %}selected{% endif %}>Dólares (USD)</option>
                    </select>
                    {% if formulario.moneda.errors %}
                        <p class="text-red-500 text-xs italic mt-1">{{ formulario.moneda.errors|first }}</p>
                    {% endif %}
                </div>

                <div class="space-y-2">
                    <label for="{{ formulario.forma_pago.id_for_label }}" class="block text-gray-700 text-sm font-bold">Forma de Pago:</label>
                    <select name="{{ formulario.forma_pago.name }}" 
                            id="{{ formulario.forma_pago.id_for_label }}"
                            class="form-control border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full"
                            required>
                        <option value="">Seleccione forma de pago</option>
                        <option value="Efectivo" {% if formulario.forma_pago.value == 'Efectivo' %}selected{% endif %}>Efectivo</option>
                        <option value="Transferencia" {% if formulario.forma_pago.value == 'Transferencia' %}selected{% endif %}>Transferencia</option>
                        <option value="Credito" {% if formulario.forma_pago.value == 'Credito' %}selected{% endif %}>Crédito</option>
                        <option value="Cheque" {% if formulario.forma_pago.value == 'Cheque' %}selected{% endif %}>Cheque</option>
                    </select>
                    {% if formulario.forma_pago.errors %}
                        <p class="text-red-500 text-xs italic mt-1">{{ formulario.forma_pago.errors|first }}</p>
                    {% endif %}
                </div>
            </div>
        </fieldset>

        <!-- Botón de Guardar -->
        <div class="flex justify-center">
            <button type="submit" class="btn bg-green-600 hover:bg-green-700 text-white py-3 px-8 rounded-lg font-medium flex items-center text-lg transition-colors duration-200">
                {% if modo == 'editar' %}
                    <i class="fas fa-save mr-2"></i> Actualizar Movimiento
                {% else %}
                    <i class="fas fa-save mr-2"></i> Guardar Movimiento
                {% endif %}
            </button>
        </div>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tipoSelect = document.getElementById('{{ formulario.tipo.id_for_label }}');
            const clasificacionSelect = document.getElementById('{{ formulario.clasificacion.id_for_label }}');
            const clasificacionActual = "{{ formulario.clasificacion.value|default:'' }}";

            function actualizarClasificaciones() {
                const tipo = tipoSelect.value;
                
                if (!tipo) {
                    clasificacionSelect.innerHTML = '<option value="">Seleccione un tipo primero</option>';
                    clasificacionSelect.disabled = true;
                    return;
                }

                clasificacionSelect.innerHTML = '<option value="">Cargando...</option>';
                clasificacionSelect.disabled = true;

                const url = `{% url 'get_classifications_for_type' '0' %}`.replace('0', tipo);
                
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        clasificacionSelect.innerHTML = '<option value="">Seleccione una clasificación</option>';
                        
                        data.classifications.forEach(function(classification) {
                            const option = new Option(classification, classification);
                            // MANTENER VALOR ACTUAL EN MODO EDICIÓN
                            if (clasificacionActual === classification) {
                                option.selected = true;
                            }
                            clasificacionSelect.add(option);
                        });
                        
                        clasificacionSelect.disabled = false;
                    })
                    .catch(error => {
                        console.error('Error al cargar clasificaciones:', error);
                        clasificacionSelect.innerHTML = '<option value="">Error al cargar clasificaciones</option>';
                        clasificacionSelect.disabled = true;
                    });
            }

            // Event listener para el cambio de tipo
            tipoSelect.addEventListener('change', actualizarClasificaciones);
            
            // Inicializar clasificaciones si hay un tipo seleccionado (importante para modo edición)
            if (tipoSelect.value) {
                actualizarClasificaciones();
            }

            // Validación del formulario antes de enviar
            const form = document.getElementById('movimiento-form');
            form.addEventListener('submit', function(e) {
                const monto = document.getElementById('{{ formulario.monto.id_for_label }}').value;
                const clasificacion = clasificacionSelect.value;
                
                if (!clasificacion) {
                    e.preventDefault();
                    alert('Por favor, seleccione una clasificación válida.');
                    return false;
                }
                
                if (!monto || parseFloat(monto) <= 0) {
                    e.preventDefault();
                    alert('Por favor, ingrese un monto válido mayor a 0.');
                    return false;
                }
            });

            // Auto-focus en el primer campo al cargar
            document.getElementById('{{ formulario.fecha.id_for_label }}').focus();
        });
    </script>

    <style>
        /* === ESTILOS ESPECÍFICOS PARA EL FORMULARIO === */
        fieldset {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: border-color 0.3s ease;
        }

        fieldset:focus-within {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        legend {
            background: white;
            padding: 0 0.75rem;
            font-weight: 600;
            color: #374151;
            border-radius: 4px;
        }

        .form-control:disabled {
            background-color: #f9fafb;
            color: #6b7280;
            cursor: not-allowed;
        }

        /* Estilo para el botón de envío */
        .btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .btn:disabled:hover {
            background-color: #9ca3af;
            transform: none;
        }

        /* Animaciones suaves */
        .space-y-2 > * + * {
            margin-top: 0.5rem;
        }

        /* Responsive improvements */
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            fieldset {
                padding: 1rem;
            }
            
            .text-lg {
                font-size: 1rem;
            }
        }
    </style>
{% endblock contenido %}


