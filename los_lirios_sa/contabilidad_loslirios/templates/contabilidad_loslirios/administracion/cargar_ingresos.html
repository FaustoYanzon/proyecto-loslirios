{% extends "contabilidad_loslirios/main.html" %}
{% load static %}

{% block titulo %}
    {% if modo == 'editar' %}Editar Ingreso{% else %}Cargar Ingresos{% endif %} - Los Lirios SA
{% endblock titulo %}

{% block contenido %}
    {# Mensajes de Django (Toastify-js los leerá y los mostrará) #}
    {% if messages %}
        <ul class="messages mb-4 hidden"> 
            {% for message in messages %}
                <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}

    <div class="flex items-center mb-6">
        <a href="{% url 'contabilidad' %}" class="text-blue-600 hover:text-blue-800 flex items-center">
            <i class="fas fa-arrow-left mr-2"></i> Volver a Administración
        </a>
        <h1 class="text-2xl font-semibold text-gray-800 ml-4">
            {% if modo == 'editar' %}
                Editar Registro de Ingreso Financiero
            {% else %}
                Cargar Ingresos Financieros
            {% endif %}
        </h1>
    </div>

    <!-- Indicador de modo edición -->
    {% if modo == 'editar' %}
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
        <div class="flex items-center">
            <i class="fas fa-info-circle text-blue-600 mr-2"></i>
            <span class="text-blue-800 font-medium">
                Editando ingreso de {{ ingreso.comprador }} del {{ ingreso.fecha|date:"d/m/Y" }} - ${{ ingreso.monto|floatformat:2 }}
            </span>
        </div>
    </div>
    {% endif %}

    <form method="POST" class="bg-white p-8 rounded-lg shadow-md" id="ingreso-form">
        {% csrf_token %}

        {% if formulario.non_field_errors %}
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-6" role="alert">
                <strong class="font-bold">¡Error al guardar!</strong>
                <span class="block sm:inline">Por favor, corrija los siguientes errores:</span>
                <ul class="mt-2 list-disc list-inside">
                    {% for error in formulario.non_field_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}

        <!-- Información General -->
        <fieldset class="border border-gray-300 p-6 rounded-md mb-6">
            <legend class="text-lg font-semibold px-3 bg-white text-gray-800">Información General</legend>
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mt-4">
                <div class="space-y-2">
                    <label for="{{ formulario.fecha.id_for_label }}" class="block text-gray-700 text-sm font-bold">Fecha:</label>
                    <input type="date" 
                           name="{{ formulario.fecha.name }}" 
                           id="{{ formulario.fecha.id_for_label }}"
                           value="{{ formulario.fecha.value|default:'' }}"
                           class="form-control border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full"
                           required>
                    {% if formulario.fecha.errors %}
                        <p class="text-red-500 text-xs italic mt-1">{{ formulario.fecha.errors|first }}</p>
                    {% endif %}
                </div>

                <div class="space-y-2">
                    <label for="{{ formulario.origen.id_for_label }}" class="block text-gray-700 text-sm font-bold">Origen:</label>
                    <select name="{{ formulario.origen.name }}" 
                            id="{{ formulario.origen.id_for_label }}"
                            class="form-control border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full"
                            required>
                        <option value="">Seleccione origen</option>
                        <option value="Oficial" {% if formulario.origen.value == 'Oficial' %}selected{% endif %}>Oficial</option>
                        <option value="No Oficial" {% if formulario.origen.value == 'No Oficial' %}selected{% endif %}>No Oficial</option>
                    </select>
                    {% if formulario.origen.errors %}
                        <p class="text-red-500 text-xs italic mt-1">{{ formulario.origen.errors|first }}</p>
                    {% endif %}
                </div>

                <div class="space-y-2">
                    <label for="{{ formulario.destino.id_for_label }}" class="block text-gray-700 text-sm font-bold">Destino:</label>
                    <div class="relative">
                        <select name="{{ formulario.destino.name }}" 
                                id="{{ formulario.destino.id_for_label }}"
                                class="form-control border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full"
                                required>
                            <option value="">Seleccione destino</option>
                            <option value="Alfalfa" {% if formulario.destino.value == 'Alfalfa' %}selected{% endif %}>Alfalfa</option>
                            <option value="Alquiler" {% if formulario.destino.value == 'Alquiler' %}selected{% endif %}>Alquiler</option>
                            <option value="Bodega" {% if formulario.destino.value == 'Bodega' %}selected{% endif %}>Bodega</option>
                            <option value="Cebolla" {% if formulario.destino.value == 'Cebolla' %}selected{% endif %}>Cebolla</option>
                            <option value="Pasa" {% if formulario.destino.value == 'Pasa' %}selected{% endif %}>Pasa</option>
                            <option value="Sandia" {% if formulario.destino.value == 'Sandia' %}selected{% endif %}>Sandía</option>
                            <option value="Uva de mesa" {% if formulario.destino.value == 'Uva de mesa' %}selected{% endif %}>Uva de mesa</option>
                        </select>
                        <!-- Solo mostrar botón en modo crear -->
                        {% if not modo == 'editar' %}
                        <button type="button" id="btn-agregar-destino" 
                                class="absolute right-2 top-2 bg-green-500 hover:bg-green-600 text-white text-xs px-2 py-1 rounded" 
                                title="Agregar nuevo destino">
                            <i class="fas fa-plus"></i>
                        </button>
                        {% endif %}
                    </div>
                    {% if formulario.destino.errors %}
                        <p class="text-red-500 text-xs italic mt-1">{{ formulario.destino.errors|first }}</p>
                    {% endif %}
                </div>
            </div>
        </fieldset>

        <!-- Información de Venta -->
        <fieldset class="border border-gray-300 p-6 rounded-md mb-6">
            <legend class="text-lg font-semibold px-3 bg-white text-gray-800">Información de Venta</legend>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                <div class="space-y-2">
                    <label for="{{ formulario.comprador.id_for_label }}" class="block text-gray-700 text-sm font-bold">Comprador:</label>
                    <div class="relative">
                        <select name="{{ formulario.comprador.name }}" 
                                id="{{ formulario.comprador.id_for_label }}"
                                class="form-control border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full"
                                required>
                            <option value="">Seleccione comprador</option>
                            <!-- Las opciones se cargan dinámicamente -->
                        </select>
                        <!-- Solo mostrar botón en modo crear -->
                        {% if not modo == 'editar' %}
                        <button type="button" id="btn-agregar-comprador" 
                                class="absolute right-2 top-2 bg-green-500 hover:bg-green-600 text-white text-xs px-2 py-1 rounded" 
                                title="Agregar nuevo comprador">
                            <i class="fas fa-plus"></i>
                        </button>
                        {% endif %}
                    </div>
                    {% if formulario.comprador.errors %}
                        <p class="text-red-500 text-xs italic mt-1">{{ formulario.comprador.errors|first }}</p>
                    {% endif %}
                </div>

                <div class="space-y-2">
                    <label for="{{ formulario.monto.id_for_label }}" class="block text-gray-700 text-sm font-bold">Monto:</label>
                    <input type="number" 
                           name="{{ formulario.monto.name }}" 
                           id="{{ formulario.monto.id_for_label }}"
                           value="{{ formulario.monto.value|default:'' }}"
                           placeholder="0.00"
                           step="0.01"
                           min="0"
                           class="form-control border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full"
                           required>
                    {% if formulario.monto.errors %}
                        <p class="text-red-500 text-xs italic mt-1">{{ formulario.monto.errors|first }}</p>
                    {% endif %}
                </div>

                <div class="space-y-2">
                    <label for="{{ formulario.moneda.id_for_label }}" class="block text-gray-700 text-sm font-bold">Moneda:</label>
                    <select name="{{ formulario.moneda.name }}" 
                            id="{{ formulario.moneda.id_for_label }}"
                            class="form-control border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full"
                            required>
                        <option value="">Seleccione moneda</option>
                        <option value="ARS" {% if formulario.moneda.value == 'ARS' %}selected{% endif %}>Pesos (ARS)</option>
                        <option value="USD" {% if formulario.moneda.value == 'USD' %}selected{% endif %}>Dólares (USD)</option>
                    </select>
                    {% if formulario.moneda.errors %}
                        <p class="text-red-500 text-xs italic mt-1">{{ formulario.moneda.errors|first }}</p>
                    {% endif %}
                </div>
            </div>
        </fieldset>

        <!-- Información de Pago -->
        <fieldset class="border border-gray-300 p-6 rounded-md mb-6">
            <legend class="text-lg font-semibold px-3 bg-white text-gray-800">Información de Pago</legend>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                <div class="space-y-2">
                    <label for="{{ formulario.forma_pago.id_for_label }}" class="block text-gray-700 text-sm font-bold">Forma de Pago:</label>
                    <select name="{{ formulario.forma_pago.name }}" 
                            id="{{ formulario.forma_pago.id_for_label }}"
                            class="form-control border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full"
                            required>
                        <option value="">Seleccione forma de pago</option>
                        <option value="Cheque" {% if formulario.forma_pago.value == 'Cheque' %}selected{% endif %}>Cheque</option>
                        <option value="Efectivo" {% if formulario.forma_pago.value == 'Efectivo' %}selected{% endif %}>Efectivo</option>
                        <option value="Transferencia" {% if formulario.forma_pago.value == 'Transferencia' %}selected{% endif %}>Transferencia</option>
                        <option value="Echeque" {% if formulario.forma_pago.value == 'Echeque' %}selected{% endif %}>Echeque</option>
                    </select>
                    {% if formulario.forma_pago.errors %}
                        <p class="text-red-500 text-xs italic mt-1">{{ formulario.forma_pago.errors|first }}</p>
                    {% endif %}
                </div>

                <div class="space-y-2">
                    <label for="{{ formulario.forma.id_for_label }}" class="block text-gray-700 text-sm font-bold">Forma:</label>
                    <select name="{{ formulario.forma.name }}" 
                            id="{{ formulario.forma.id_for_label }}"
                            class="form-control border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full"
                            required>
                        <option value="">Seleccione forma</option>
                        <option value="Caja" {% if formulario.forma.value == 'Caja' %}selected{% endif %}>Caja</option>
                        <option value="Bsj" {% if formulario.forma.value == 'Bsj' %}selected{% endif %}>Bsj</option>
                        <option value="MP camilo" {% if formulario.forma.value == 'MP camilo' %}selected{% endif %}>MP camilo</option>
                        <option value="GM" {% if formulario.forma.value == 'GM' %}selected{% endif %}>GM</option>
                        <option value="Naranja Nico" {% if formulario.forma.value == 'Naranja Nico' %}selected{% endif %}>Naranja Nico</option>
                        <option value="Galicia Nico" {% if formulario.forma.value == 'Galicia Nico' %}selected{% endif %}>Galicia Nico</option>
                    </select>
                    {% if formulario.forma.errors %}
                        <p class="text-red-500 text-xs italic mt-1">{{ formulario.forma.errors|first }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- Campos condicionales para Cheque/Echeque -->
            <div id="campos-cheque" class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-4" style="display: none;">
                <div class="space-y-2">
                    <label for="{{ formulario.banco.id_for_label }}" class="block text-gray-700 text-sm font-bold">Banco:</label>
                    <input type="text" 
                           name="{{ formulario.banco.name }}" 
                           id="{{ formulario.banco.id_for_label }}"
                           value="{{ formulario.banco.value|default:'' }}"
                           placeholder="Nombre del banco"
                           class="form-control border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full">
                    {% if formulario.banco.errors %}
                        <p class="text-red-500 text-xs italic mt-1">{{ formulario.banco.errors|first }}</p>
                    {% endif %}
                </div>

                <div class="space-y-2">
                    <label for="{{ formulario.numero_cheque.id_for_label }}" class="block text-gray-700 text-sm font-bold">N° de Cheque:</label>
                    <input type="text" 
                           name="{{ formulario.numero_cheque.name }}" 
                           id="{{ formulario.numero_cheque.id_for_label }}"
                           value="{{ formulario.numero_cheque.value|default:'' }}"
                           placeholder="Número de cheque"
                           class="form-control border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full">
                    {% if formulario.numero_cheque.errors %}
                        <p class="text-red-500 text-xs italic mt-1">{{ formulario.numero_cheque.errors|first }}</p>
                    {% endif %}
                </div>

                <div class="space-y-2">
                    <label for="{{ formulario.fecha_pago.id_for_label }}" class="block text-gray-700 text-sm font-bold">Fecha de Pago:</label>
                    <input type="date" 
                           name="{{ formulario.fecha_pago.name }}" 
                           id="{{ formulario.fecha_pago.id_for_label }}"
                           value="{{ formulario.fecha_pago.value|default:'' }}"
                           class="form-control border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full">
                    {% if formulario.fecha_pago.errors %}
                        <p class="text-red-500 text-xs italic mt-1">{{ formulario.fecha_pago.errors|first }}</p>
                    {% endif %}
                </div>
            </div>
        </fieldset>

        <!-- Botón de Guardar -->
        <div class="flex justify-center">
            <button type="submit" class="btn bg-green-600 hover:bg-green-700 text-white py-3 px-8 rounded-lg font-medium flex items-center text-lg transition-colors duration-200">
                {% if modo == 'editar' %}
                    <i class="fas fa-save mr-2"></i> Actualizar Ingreso
                {% else %}
                    <i class="fas fa-save mr-2"></i> Guardar Ingreso
                {% endif %}
            </button>
        </div>
    </form>

    <!-- Modales para agregar destino/comprador - Solo en modo crear -->
    {% if not modo == 'editar' %}
    <div id="modal-destino" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Agregar Nuevo Destino</h3>
                    <button onclick="cerrarModal('modal-destino')" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <input type="text" id="nuevo-destino" placeholder="Nombre del destino" 
                           class="form-control border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full">
                    <div class="flex justify-end space-x-2">
                        <button onclick="cerrarModal('modal-destino')" 
                                class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                            Cancelar
                        </button>
                        <button onclick="agregarDestino()" 
                                class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                            Agregar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-comprador" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Agregar Nuevo Comprador</h3>
                    <button onclick="cerrarModal('modal-comprador')" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <input type="text" id="nuevo-comprador" placeholder="Nombre del comprador" 
                           class="form-control border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full">
                    <div class="flex justify-end space-x-2">
                        <button onclick="cerrarModal('modal-comprador')" 
                                class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                            Cancelar
                        </button>
                        <button onclick="agregarComprador()" 
                                class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                            Agregar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const formaPagoSelect = document.getElementById('{{ formulario.forma_pago.id_for_label }}');
            const camposCheque = document.getElementById('campos-cheque');
            const destinoSelect = document.getElementById('{{ formulario.destino.id_for_label }}');
            const compradorSelect = document.getElementById('{{ formulario.comprador.id_for_label }}');

            // === FUNCIÓN PARA MOSTRAR/OCULTAR CAMPOS DE CHEQUE ===
            function toggleCamposCheque() {
                const formaPago = formaPagoSelect.value;
                if (formaPago === 'Cheque' || formaPago === 'Echeque') {
                    camposCheque.style.display = 'grid';
                    // Hacer campos obligatorios
                    document.getElementById('{{ formulario.banco.id_for_label }}').required = true;
                    document.getElementById('{{ formulario.numero_cheque.id_for_label }}').required = true;
                    document.getElementById('{{ formulario.fecha_pago.id_for_label }}').required = true;
                } else {
                    camposCheque.style.display = 'none';
                    // Quitar campos obligatorios
                    document.getElementById('{{ formulario.banco.id_for_label }}').required = false;
                    document.getElementById('{{ formulario.numero_cheque.id_for_label }}').required = false;
                    document.getElementById('{{ formulario.fecha_pago.id_for_label }}').required = false;
                }
            }

            // === CARGAR DESTINOS Y COMPRADORES ===
            function cargarDestinos() {
                fetch('{% url "get_destinos_ingresos" %}')
                    .then(response => response.json())
                    .then(data => {
                        const destinoActual = '{{ formulario.destino.value|default:"" }}';
                        destinoSelect.innerHTML = '<option value="">Seleccione destino</option>';
                        
                        // Agregar destinos predefinidos
                        const destinosPredefinidos = ['Alfalfa', 'Alquiler', 'Bodega', 'Cebolla', 'Pasa', 'Sandia', 'Uva de mesa'];
                        destinosPredefinidos.forEach(destino => {
                            const option = new Option(destino, destino);
                            if (destino === destinoActual) option.selected = true;
                            destinoSelect.add(option);
                        });
                        
                        // Agregar destinos personalizados
                        data.destinos.forEach(destino => {
                            if (!destinosPredefinidos.includes(destino)) {
                                const option = new Option(destino, destino);
                                if (destino === destinoActual) option.selected = true;
                                destinoSelect.add(option);
                            }
                        });
                    })
                    .catch(error => console.error('Error al cargar destinos:', error));
            }

            function cargarCompradores() {
                fetch('{% url "get_compradores_ingresos" %}')
                    .then(response => response.json())
                    .then(data => {
                        const compradorActual = '{{ formulario.comprador.value|default:"" }}';
                        compradorSelect.innerHTML = '<option value="">Seleccione comprador</option>';
                        
                        data.compradores.forEach(comprador => {
                            const option = new Option(comprador, comprador);
                            if (comprador === compradorActual) option.selected = true;
                            compradorSelect.add(option);
                        });
                    })
                    .catch(error => console.error('Error al cargar compradores:', error));
            }

            // === EVENT LISTENERS ===
            formaPagoSelect.addEventListener('change', toggleCamposCheque);
            
            {% if not modo == 'editar' %}
            // Solo agregar listeners en modo crear
            document.getElementById('btn-agregar-destino').addEventListener('click', () => abrirModal('modal-destino'));
            document.getElementById('btn-agregar-comprador').addEventListener('click', () => abrirModal('modal-comprador'));
            {% endif %}

            // === VALIDACIÓN DEL FORMULARIO ===
            document.getElementById('ingreso-form').addEventListener('submit', function(e) {
                const monto = document.getElementById('{{ formulario.monto.id_for_label }}').value;
                const formaPago = formaPagoSelect.value;
                
                if (!monto || parseFloat(monto) <= 0) {
                    e.preventDefault();
                    alert('Por favor, ingrese un monto válido mayor a 0.');
                    return false;
                }
                
                if ((formaPago === 'Cheque' || formaPago === 'Echeque')) {
                    const banco = document.getElementById('{{ formulario.banco.id_for_label }}').value;
                    const numeroCheque = document.getElementById('{{ formulario.numero_cheque.id_for_label }}').value;
                    const fechaPago = document.getElementById('{{ formulario.fecha_pago.id_for_label }}').value;
                    
                    if (!banco || !numeroCheque || !fechaPago) {
                        e.preventDefault();
                        alert('Para pagos con Cheque o Echeque, debe completar Banco, N° de Cheque y Fecha de Pago.');
                        return false;
                    }
                }
            });

            // === INICIALIZACIÓN ===
            toggleCamposCheque();
            cargarDestinos();
            cargarCompradores();
            document.getElementById('{{ formulario.fecha.id_for_label }}').focus();
        });

        {% if not modo == 'editar' %}
        // === FUNCIONES GLOBALES PARA MODALES (solo en modo crear) ===
        function abrirModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function cerrarModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            if (modalId === 'modal-destino') {
                document.getElementById('nuevo-destino').value = '';
            } else if (modalId === 'modal-comprador') {
                document.getElementById('nuevo-comprador').value = '';
            }
        }

        function agregarDestino() {
            const nombre = document.getElementById('nuevo-destino').value.trim();
            if (!nombre) {
                alert('Por favor, ingrese un nombre para el destino.');
                return;
            }

            fetch('{% url "agregar_destino_ingreso" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `nombre=${encodeURIComponent(nombre)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Recargar destinos y seleccionar el nuevo
                    const destinoSelect = document.getElementById('{{ formulario.destino.id_for_label }}');
                    const option = new Option(nombre, nombre);
                    option.selected = true;
                    destinoSelect.add(option);
                    cerrarModal('modal-destino');
                    alert('Destino agregado exitosamente.');
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al agregar el destino.');
            });
        }

        function agregarComprador() {
            const nombre = document.getElementById('nuevo-comprador').value.trim();
            if (!nombre) {
                alert('Por favor, ingrese un nombre para el comprador.');
                return;
            }

            fetch('{% url "agregar_comprador_ingreso" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `nombre=${encodeURIComponent(nombre)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Recargar compradores y seleccionar el nuevo
                    const compradorSelect = document.getElementById('{{ formulario.comprador.id_for_label }}');
                    const option = new Option(nombre, nombre);
                    option.selected = true;
                    compradorSelect.add(option);
                    cerrarModal('modal-comprador');
                    alert('Comprador agregado exitosamente.');
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al agregar el comprador.');
            });
        }

        // Cerrar modales al hacer clic fuera
        document.addEventListener('click', function(e) {
            if (e.target.id === 'modal-destino' || e.target.id === 'modal-comprador') {
                cerrarModal(e.target.id);
            }
        });
        {% endif %}
    </script>

    <style>
        /* === ESTILOS ESPECÍFICOS PARA EL FORMULARIO === */
        fieldset {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: border-color 0.3s ease;
        }

        fieldset:focus-within {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        legend {
            background: white;
            padding: 0 0.75rem;
            font-weight: 600;
            color: #374151;
            border-radius: 4px;
        }

        .form-control:disabled {
            background-color: #f9fafb;
            color: #6b7280;
            cursor: not-allowed;
        }

        /* Estilo para el botón de envío */
        .btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .btn:disabled:hover {
            background-color: #9ca3af;
            transform: none;
        }

        /* Animaciones suaves */
        .space-y-2 > * + * {
            margin-top: 0.5rem;
        }

        /* Responsive improvements */
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            fieldset {
                padding: 1rem;
            }
            
            .text-lg {
                font-size: 1rem;
            }
        }

        /* Estilos para botones pequeños */
        .absolute button {
            z-index: 10;
        }
    </style>
{% endblock contenido %}