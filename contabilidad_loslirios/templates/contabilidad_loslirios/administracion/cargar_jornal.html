{% extends "contabilidad_loslirios/main.html" %}
{% load static %}
{% block contenido %}
        {# Mensajes de Django (Toastify-js los leerá y los mostrará) #}
        {% if messages %}
            <ul class="messages mb-4 hidden"> {# Añade 'hidden' para que no se muestren dos veces #}
                {% for message in messages %}
                    <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
                {% endfor %}
            </ul>
        {% endif %}
        <div class="flex items-center mb-6">
            <a href="{% url 'contabilidad' %}" class="text-blue-600 hover:text-blue-800 flex items-center">
                <i class="fas fa-arrow-left mr-2"></i> Volver a Administracion
            </a>
            <h1 class="text-2xl font-semibold text-gray-800 ml-4">Cargar Jornales</h1>
        </div>

        <form method="post" id="formulario-jornales">
            {% csrf_token %}
            {{ formset.management_form }}
            <table class="table-auto w-full" id="tabla-jornales">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Nombre Trabajador</th>
                        <th>Clasificación</th>
                        <th>Tarea</th>
                        <th>Detalle</th>
                        <th>Cantidad</th>
                        <th>Unidad Medida</th>
                        <th>Precio</th>
                        <th>Ubicación</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody>
                    {% for form in formset %}
                    <tr class="formset-row">
                        {% for field in form.visible_fields %}
                            {% if field.name == "fecha" %}
                            <td>
                                {{ field }}
                                <button type="button" class="btn-copiar-fecha bg-gray-300 text-xs px-2 py-1 rounded ml-1" title="Copiar fecha anterior">⮌</button>
                            </td>
                            {% else %}
                            <td>{{ field }}</td>
                            {% endif %}
                        {% endfor %}
                        <td>
                            <button type="button" class="btn-eliminar bg-red-500 text-white px-2 py-1 rounded">Eliminar</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <button type="button" id="btn-agregar" class="bg-blue-600 text-white py-2 px-4 rounded-lg font-medium mb-4">
                <i class="fas fa-plus mr-2"></i>Agregar fila
            </button>
            <button type="submit" class="btn bg-green-600 text-white py-2 px-6 rounded-lg font-medium flex items-center">
                <i class="fas fa-save mr-2"></i>Cargar
            </button>
        </form>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Función para actualizar el select de tareas según la clasificación ---
        function actualizarTareas(clasificacionSelect, tareaSelect) {
            const clasificacion = clasificacionSelect.value;
            if (!clasificacion) {
                tareaSelect.innerHTML = '<option value="">Seleccione una clasificación primero</option>';
                tareaSelect.disabled = true;
                return;
            }
            tareaSelect.innerHTML = '<option value="">Cargando...</option>';
            tareaSelect.disabled = true;
            fetch(`/api/administracion/get-tasks/${clasificacion}/`)
                .then(response => response.json())
                .then(data => {
                    tareaSelect.innerHTML = '';
                    tareaSelect.add(new Option('Seleccione una tarea', ''));
                    data.tasks.forEach(function(task) {
                        tareaSelect.add(new Option(task, task));
                    });
                    tareaSelect.disabled = false;
                })
                .catch(error => {
                    tareaSelect.innerHTML = '<option value="">Error al cargar tareas</option>';
                    tareaSelect.disabled = true;
                });
        }

        // --- Función para enlazar eventos a todos los selects de clasificación ---
        function bindClasificacionEvents() {
            document.querySelectorAll('select[name$="-clasificacion"]').forEach(function(clasificacionSelect) {
                const row = clasificacionSelect.closest('tr');
                const tareaSelect = row.querySelector('select[name$="-tarea"]');
                if (clasificacionSelect && tareaSelect) {
                    // Evita duplicar el evento
                    clasificacionSelect.onchange = null;
                    clasificacionSelect.addEventListener('change', function() {
                        actualizarTareas(clasificacionSelect, tareaSelect);
                    });
                    // Inicializa el select de tarea si hay valor preseleccionado
                    actualizarTareas(clasificacionSelect, tareaSelect);
                }
            });
        }

        // --- Inicializa los eventos al cargar la página ---
        bindClasificacionEvents();

        // --- Cuando agregas una fila, vuelve a enlazar los eventos ---
        document.getElementById('btn-agregar').addEventListener('click', function() {
            setTimeout(bindClasificacionEvents, 100); // Espera a que la fila se agregue
        });

        // --- También vuelve a enlazar los eventos al eliminar una fila ---
        document.getElementById('tabla-jornales').addEventListener('click', function(e) {
            if (e.target.classList.contains('btn-eliminar')) {
                setTimeout(bindClasificacionEvents, 100);
            }
        });
    });

    // --- Dinámica de agregar/eliminar filas ---
    document.addEventListener('DOMContentLoaded', function() {
        const tabla = document.getElementById('tabla-jornales').getElementsByTagName('tbody')[0];
        const btnAgregar = document.getElementById('btn-agregar');
        const totalForms = document.getElementById('id_form-TOTAL_FORMS');

        btnAgregar.addEventListener('click', function() {
            // Clona la última fila
            const filas = tabla.querySelectorAll('.formset-row');
            const ultimaFila = filas[filas.length - 1];
            const nuevaFila = ultimaFila.cloneNode(true);

            // Limpia los valores de los inputs
            nuevaFila.querySelectorAll('input, select, textarea').forEach(function(input) {
                if (input.type === 'checkbox' || input.type === 'radio') {
                    input.checked = false;
                } else {
                    input.value = '';
                }
            });

            // Actualiza los atributos name e id para el formset
            const formIndex = parseInt(totalForms.value);
            nuevaFila.querySelectorAll('input, select, textarea').forEach(function(input) {
                if (input.name) {
                    input.name = input.name.replace(/form-(\d+)-/, `form-${formIndex}-`);
                }
                if (input.id) {
                    input.id = input.id.replace(/form-(\d+)-/, `form-${formIndex}-`);
                }
            });

            tabla.appendChild(nuevaFila);
            totalForms.value = formIndex + 1;
        });

        // Eliminar fila
        tabla.addEventListener('click', function(e) {
            if (e.target.classList.contains('btn-eliminar')) {
                const filas = tabla.querySelectorAll('.formset-row');
                if (filas.length > 1) {
                    e.target.closest('.formset-row').remove();
                    totalForms.value = filas.length - 1;
                }
            }
        });
    });
    </script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('tabla-jornales').addEventListener('click', function(e) {
        if (e.target.classList.contains('btn-copiar-fecha')) {
            const filaActual = e.target.closest('tr');
            const filas = Array.from(document.querySelectorAll('#tabla-jornales .formset-row'));
            const idx = filas.indexOf(filaActual);
            if (idx > 0) {
                const fechaAnterior = filas[idx - 1].querySelector('input[name$="-fecha"]').value;
                filaActual.querySelector('input[name$="-fecha"]').value = fechaAnterior;
            }
        }
    });
});
</script>
<style>
    #tabla-jornales input,
    #tabla-jornales select,
    #tabla-jornales textarea {
        max-width: 140px;
        min-width: 80px;
        width: 120px;
        box-sizing: border-box;
    }
    #tabla-jornales th, #tabla-jornales td {
        padding: 4px;
    }
</style>
{% endblock %}